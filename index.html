<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Blessing of Siam</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@400;700&display=swap" rel="stylesheet" />
  <style>
    /* Base Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: 'Noto Sans Thai', sans-serif;
      background: linear-gradient(135deg, #ffffff 0%, #8b0000 100%);
      color: #000;
      transition: background 0.5s, color 0.5s;
      position: relative;
      min-height: 100vh;
      overflow: auto;
    }

    /* Temple-Specific Themes - Ensured consistent naming */
    .theme-wat-pra-kew { background: linear-gradient(135deg, #87ceeb 0%, #0066cc 100%); color: #000; }
    .theme-wat-po { background: linear-gradient(135deg, #d2b48c 0%, #8b4513 100%); color: #000; }
    .theme-wat-benchamabophit { background: linear-gradient(135deg, #ffffff 0%, #8b0000 100%); color: #000; }
    .theme-wat-phra-singh { background: linear-gradient(135deg, #ffd700 0%, #8b0000 100%); color: #000; }
    .theme-wat-phnom-penh { background: linear-gradient(135deg, #008000 0%, #000080 100%); color: #fff; }
    .theme-wat-suthat { background: linear-gradient(135deg, #8b0000 0%, #008000 100%); color: #fff; }
    .theme-wat-arun { background: linear-gradient(135deg, #0066cc 0%, #ffffff 100%); color: #000; }
    .theme-wat-chedi-luang { background: linear-gradient(135deg, #8b0000 0%, #8b4513 100%); color: #fff; }
    .theme-wat-traimit { background: linear-gradient(135deg, #006600 0%, #8b0000 100%); color: #fff; }

    /* Quote Card */
    .quote-card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      max-width: 90%;
      width: 600px;
      padding: 20px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 10px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      display: none;
      text-align: center;
      font-size: 1.1em;
      transition: all 0.5s ease;
    }

    .quote-card.show {
      display: block;
    }

    .pali-text {
      font-family: 'Noto Sans Thai', sans-serif;
      font-size: 1.2em;
      line-height: 1.6;
      margin-bottom: 10px;
    }

    .english-reading {
      font-size: 0.9em;
      color: #555;
      font-style: italic;
      margin: 10px 0;
      opacity: 0.85;
    }

    .quote-source {
      font-size: 0.9em;
      margin-top: 10px;
      color: #888;
    }

    .quote-actions {
      margin-top: 15px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }

    .action-btn {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      border: none;
    }

    .blessing-btn {
      background: linear-gradient(135deg, #ffffff 0%, #8b0000 100%);
      color: #000;
    }

    .secondary-btn {
      background: #f0f0f0;
      color: #333;
      border: 1px solid #ccc;
    }

    .favorite-btn.favorited {
      background: linear-gradient(135deg, #ff4444 0%, #cc0000 100%);
      color: #fff;
    }

    /* Notification & TTS Status */
    .notification, .tts-status {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 20px;
      z-index: 1000;
      display: none;
      font-size: 0.9em;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    /* Controls */
    .controls {
      position: fixed;
      top: 20px;
      left: 20px;
      right: 20px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      z-index: 998;
    }

    .theme-selector, .source-filter {
      padding: 8px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.9em;
      min-width: 150px;
      background-color: rgba(255, 255, 255, 0.9);
    }

    /* Mandala Animation */
    .mandala {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      pointer-events: none;
      z-index: 999;
      animation: mandalaPulse 3s ease-out forwards;
      opacity: 0.4;
    }

    @keyframes mandalaPulse {
      0% { transform: scale(0.1); opacity: 0.8; }
      50% { transform: scale(1.5); opacity: 0.2; }
      100% { transform: scale(2); opacity: 0; }
    }

    .mandala::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 150px;
      height: 150px;
      background: radial-gradient(circle at 50% 50%, #ffd700 0%, transparent 70%);
      border-radius: 50%;
      box-shadow: 0 0 15px #ffd70080;
      animation: mandalaCenter 2s infinite;
    }

    @keyframes mandalaCenter {
      0% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 15px #ffd70080; }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 25px #ffd70080; }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 15px #ffd70080; }
    }

    /* Mobile Floating Button */
    @media (max-width: 600px) {
      .blessing-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1000;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
    }
  </style>
</head>
<body>
  <div class="controls">
    <select class="theme-selector" id="themeSelector">
      <option value="theme-wat-pra-kew">Wat Pra Kew</option>
      <option value="theme-wat-po">Wat Po</option>
      <option value="theme-wat-benchamabophit">Wat Benchamabophit</option>
      <option value="theme-wat-phra-singh">Wat Phra Singh</option>
      <option value="theme-wat-phnom-penh">Wat Phnom Penh</option>
      <option value="theme-wat-suthat">Wat Suthat</option>
      <option value="theme-wat-arun">Wat Arun</option>
      <option value="theme-wat-chedi-luang">Wat Chedi Luang</option>
      <option value="theme-wat-traimit">Wat Traimit</option>
    </select>

    <select class="source-filter" id="sourceFilter">
      <option value="all">All Sources</option>
      <option value="Buddhism">Buddhism</option>
    </select>

    <select class="source-filter" id="ttsLanguage">
      <option value="th-TH">Pali (Thai)</option>
      <option value="en-US">English</option>
    </select>
    <button class="action-btn blessing-btn" id="starButton">Generate Passage</button>
  </div>

  <div class="quote-card" id="quoteCard">
    <div class="quote-text pali-text" id="quoteText"></div>
    <div class="english-reading" id="englishReading"></div>
    <div class="quote-source" id="quoteSource"></div>
    <div class="quote-actions">
      <button class="action-btn blessing-btn" id="blessingBtn">üôèüèª Send Blessing</button>
      <button class="action-btn secondary-btn" id="wwbappsBtn">üôèüèª wwbapps</button>
      <button class="action-btn secondary-btn" id="playBtn">üîä Listen</button>
      <button class="action-btn secondary-btn" id="favoriteBtn">‚ù§Ô∏è Save</button>
      <button class="action-btn secondary-btn" id="shareBtn">üì§ Share</button>
      <button class="action-btn secondary-btn" id="copyBtn">üìã Copy</button>
    </div>
  </div>

  <div class="notification" id="ttsStatus"></div>
  <div class="notification" id="notification"></div>

  <script>
    // Log for debugging
    console.log("Blessing of Siam - App Loading...");

    // Passages data - Removed temple and englishTranslation, added englishReading
    let passages = [
      {
        text: "‡∏≠‡∏¥‡∏ï‡∏¥‡∏õ‡∏¥‡πÇ‡∏™ ‡∏†‡∏∞‡∏Ñ‡∏∞‡∏ß‡∏≤ ‡∏≠‡∏∞‡∏£‡∏∞‡∏´‡∏±‡∏á ‡∏™‡∏±‡∏°‡∏°‡∏≤ ‡∏™‡∏±‡∏°‡∏û‡∏∏‡∏ó‡πÇ‡∏ò ‡∏ß‡∏¥‡∏ä‡∏ä‡∏≤‡∏à‡∏∞‡∏£‡∏∞‡∏ì‡∏∞‡∏™‡∏±‡∏°‡∏õ‡∏±‡∏ô‡πÇ‡∏ô ‡∏™‡∏∏‡∏Ñ‡∏∞‡πÇ‡∏ï ‡πÇ‡∏•‡∏Å‡∏∞‡∏ß‡∏¥‡∏ó‡∏π ‡∏≠‡∏∞‡∏ô‡∏∏‡∏ï‡∏ï‡∏∞‡πÇ‡∏£ ‡∏õ‡∏∏‡∏£‡∏¥‡∏™‡∏∞‡∏ó‡∏±‡∏°‡∏°‡∏∞‡∏™‡∏≤‡∏£‡∏∞‡∏ñ‡∏¥ ‡∏™‡∏±‡∏ï‡∏ñ‡∏≤ ‡πÄ‡∏ó‡∏ß‡∏∞‡∏°‡∏∞‡∏ô‡∏∏‡∏™‡∏™‡∏≤‡∏ô‡∏±‡∏á ‡∏û‡∏∏‡∏ó‡πÇ‡∏ò ‡∏†‡∏∞‡∏Ñ‡∏∞‡∏ß‡∏≤‡∏ï‡∏¥ ‡∏™‡∏∞‡∏ß‡∏≤‡∏Å‡∏Ç‡∏≤‡πÇ‡∏ï ‡∏†‡∏∞‡∏Ñ‡∏∞‡∏ß‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡πÇ‡∏° ‡∏™‡∏±‡∏ô‡∏ó‡∏¥‡∏è‡∏ê‡∏¥‡πÇ‡∏Å ‡∏≠‡∏∞‡∏Å‡∏≤‡∏•‡∏¥‡πÇ‡∏Å ‡πÄ‡∏≠‡∏´‡∏¥‡∏õ‡∏±‡∏™‡∏™‡∏¥‡πÇ‡∏Å ‡πÇ‡∏≠‡∏õ‡∏∞‡∏ô‡∏∞‡∏¢‡∏¥‡πÇ‡∏Å ‡∏õ‡∏±‡∏à‡∏à‡∏±‡∏ï‡∏ï‡∏±‡∏á ‡πÄ‡∏ß‡∏ó‡∏¥‡∏ï‡∏±‡∏û‡πÇ‡∏û ‡∏ß‡∏¥‡∏ç‡∏ç‡∏π‡∏´‡∏¥‡∏ï‡∏¥",
        englishReading: "Itipiso paka...",
        id: 1,
        source: "Buddhism",
        category: "Bhuda Bless1",
        theme: "theme-wat-pra-kew"
      },
      {
        text: "‡∏ï‡∏¥ ‡∏ß‡∏≤ ‡∏Ñ‡∏∞ ‡∏†‡∏∞ ‡πÇ‡∏ò ‡∏û‡∏∏‡∏ó ‡∏ô‡∏±‡∏á ‡∏™‡∏≤ ‡∏ô‡∏∏‡∏™ ‡∏°‡∏∞ ‡∏ß‡∏∞ ‡πÄ‡∏ó ‡∏ñ‡∏≤ ‡∏™‡∏±‡∏ï ‡∏ñ‡∏¥ ‡∏£‡∏∞ ‡∏™‡∏≤ ‡∏°‡∏∞ ‡∏ó‡∏±‡∏° ‡∏™‡∏∞ ‡∏£‡∏¥ ‡∏õ‡∏∏ ‡πÇ‡∏£ ‡∏ï‡∏∞ ‡∏ô‡∏∏‡∏ï ‡∏≠‡∏∞ ‡∏ó‡∏π ‡∏ß‡∏¥ ‡∏Å‡∏∞ ‡πÇ‡∏• ‡πÇ‡∏ï ‡∏Ñ‡∏∞ ‡∏™‡∏∏ ‡πÇ‡∏ô ‡∏õ‡∏±‡∏ô ‡∏™‡∏±‡∏° ‡∏ì‡∏∞ ‡∏£‡∏∞ ‡∏à‡∏∞ ‡∏ä‡∏≤ ‡∏ß‡∏¥‡∏ä ‡πÇ‡∏ò ‡∏û‡∏∏‡∏ó ‡∏™‡∏±‡∏° ‡∏°‡∏≤ ‡∏™‡∏±‡∏° ‡∏´‡∏±‡∏á ‡∏£‡∏∞ ‡∏≠‡∏∞ ‡∏ß‡∏≤ ‡∏Ñ‡∏∞ ‡∏†‡∏∞ ‡πÇ‡∏™ ‡∏õ‡∏¥ ‡∏ï‡∏¥ ‡∏≠‡∏¥",
        englishReading: "Ti wa ka pha tho...",
        id: 2,
        source: "Buddhism",
        category: "Bhuda Bless2",
        theme: "theme-wat-po"
      },
      {
        text: "‡∏Å‡∏∏‡∏™‡∏∞‡∏•‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏Å‡∏∏‡∏™‡∏∞‡∏•‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Kusala dhamma...",
        id: 3,
        source: "Buddhism",
        category: "Bhuda Bless3",
        theme: "theme-wat-benchamabophit"
      },
      {
        text: "‡∏™‡∏∏‡∏Ç‡∏≤‡∏¢‡∏∞ ‡πÄ‡∏ß‡∏ó‡∏∞‡∏ô‡∏≤‡∏¢‡∏∞ ‡∏™‡∏±‡∏°‡∏õ‡∏∞‡∏¢‡∏∏‡∏ï‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏ó‡∏∏‡∏Å‡∏Ç‡∏≤‡∏¢‡∏∞ ‡πÄ‡∏ß‡∏ó‡∏∞‡∏ô‡∏≤‡∏¢‡∏∞ ‡∏™‡∏±‡∏°‡∏õ‡∏∞‡∏¢‡∏∏‡∏ï‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∏‡πÄ‡∏õ‡∏Å‡∏Ç‡∏≤‡∏™‡∏∞‡∏´‡∏∞‡∏Ñ‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Sukhaya vedanaya...",
        id: 4,
        source: "Buddhism",
        category: "Bhuda Bless4",
        theme: "theme-wat-phra-singh"
      },
      {
        text: "‡∏ß‡∏¥‡∏õ‡∏≤‡∏Å‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏ß‡∏¥‡∏õ‡∏≤‡∏Å‡∏∞‡∏ò‡∏±‡∏°‡∏°‡∏∞‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡πÄ‡∏ô‡∏ß‡∏∞‡∏ß‡∏¥‡∏õ‡∏≤‡∏Å‡∏∞‡∏ô‡∏∞‡∏ß‡∏¥‡∏õ‡∏≤‡∏Å‡∏∞‡∏ò‡∏±‡∏°‡∏°‡∏∞‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Vipaka dhamma...",
        id: 5,
        source: "Buddhism",
        category: "Bhuda Bless5",
        theme: "theme-wat-phnom-penh"
      },
      {
        text: "‡∏≠‡∏∏‡∏õ‡∏≤‡∏ó‡∏¥‡∏ô‡∏ô‡∏∏‡∏õ‡∏≤‡∏ó‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏ô‡∏∏‡∏õ‡∏≤‡∏ó‡∏¥‡∏ô‡∏ô‡∏∏‡∏õ‡∏≤‡∏ó‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏ô‡∏∏‡∏õ‡∏≤‡∏ó‡∏¥‡∏ô‡∏ô‡∏∏‡∏õ‡∏≤‡∏ó‡∏≤‡∏ô‡∏¥‡∏¢‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Upadinna upadanaya...",
        id: 6,
        source: "Buddhism",
        category: "Bhuda Bless6",
        theme: "theme-wat-suthat"
      },
      {
        text: "‡∏™‡∏±‡∏á‡∏Å‡∏¥‡∏•‡∏¥‡∏è‡∏ê‡∏∞‡∏™‡∏±‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏¥‡∏Å‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏™‡∏±‡∏á‡∏Å‡∏¥‡∏•‡∏¥‡∏è‡∏ê‡∏∞‡∏™‡∏±‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏¥‡∏Å‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏™‡∏±‡∏á‡∏Å‡∏¥‡∏•‡∏¥‡∏è‡∏ê‡∏≤‡∏™‡∏±‡∏á‡∏Å‡∏¥‡πÄ‡∏•‡∏™‡∏¥‡∏Å‡∏≤‡∏ò‡∏±‡∏°‡∏°‡∏≤‡∏Ø",
        englishReading: "Sankilittha sankilesika...",
        id: 7,
        source: "Buddhism",
        category: "Bhuda Bless7",
        theme: "theme-wat-arun"
      },
      {
        text: "‡∏™‡∏∞‡∏ß‡∏¥‡∏ï‡∏±‡∏Å‡∏Å‡∏∞‡∏™‡∏∞‡∏ß‡∏¥‡∏à‡∏≤‡∏£‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏ß‡∏¥‡∏ï‡∏±‡∏Å‡∏Å‡∏∞‡∏ß‡∏¥‡∏à‡∏≤‡∏£‡∏∞‡∏°‡∏±‡∏ï‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∞‡∏ß‡∏¥‡∏ï‡∏±‡∏Å‡∏Å‡∏≤‡∏ß‡∏¥‡∏à‡∏≤‡∏£‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Savittakka savicara...",
        id: 8,
        source: "Buddhism",
        category: "Bhuda Bless8",
        theme: "theme-wat-chedi-luang"
      },
      {
        text: "‡∏õ‡∏µ‡∏ï‡∏¥‡∏™‡∏∞‡∏´‡∏∞‡∏Ñ‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏™‡∏∏‡∏Ç‡∏∞‡∏™‡∏∞‡∏´‡∏∞‡∏Ñ‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏≠‡∏∏‡πÄ‡∏õ‡∏Å‡∏Ç‡∏≤‡∏™‡∏∞‡∏´‡∏∞‡∏Ñ‡∏∞‡∏ï‡∏≤ ‡∏ò‡∏±‡∏°‡∏°‡∏≤ ‡∏Ø",
        englishReading: "Piti sahagata...",
        id: 9,
        source: "Buddhism",
        category: "Bhuda Bless9",
        theme: "theme-wat-traimit"
      }
    ];

    // State management
    let usedPassages = [];
    let favorites = [];
    let quotesRead = 0;
    let currentQuote = null;
    let isGenerating = false;
    let currentUtterance = null;

    // Initialize from local storage if available
    try {
      usedPassages = JSON.parse(localStorage.getItem('usedPassages')) || [];
      favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      quotesRead = parseInt(localStorage.getItem('quotesRead')) || 0;
      console.log("Loaded from localStorage:", { usedPassages, favorites, quotesRead });
    } catch (e) {
      console.error("Error loading from localStorage:", e);
      showNotification("Failed to load saved data. Resetting...");
    }

    // Create mandala animation
    function createMandalaAnimation(templeTheme) {
      try {
        console.log("Creating mandala animation for:", templeTheme);
        const mandala = document.createElement('div');
        mandala.className = 'mandala';

        // Set mandala color based on temple - using consistent theme names
        switch (templeTheme) {
          case 'theme-wat-pra-kew':
            mandala.style.background = 'radial-gradient(circle at 50% 50%, #87ceeb 0%, transparent 70%)';
            mandala.style.boxShadow = '0 0 20px #87ceeb80';
            break;
          case 'theme-wat-po':
            mandala.style.background = 'radial-gradient(circle at 50% 50%, #d2b48c 0%, transparent 70%)';
            mandala.style.boxShadow = '0 0 20px #d2b48c80';
            break;
          default:
            mandala.style.background = 'radial-gradient(circle at 50% 50%, #ffd700 0%, transparent 70%)';
            mandala.style.boxShadow = '0 0 20px #ffd70080';
            break;
        }

        document.body.appendChild(mandala);
        console.log("Mandala added to DOM");

        setTimeout(() => {
          if (document.body.contains(mandala)) {
            document.body.removeChild(mandala);
            console.log("Mandala removed from DOM");
          }
        }, 3000);
      } catch (e) {
        console.error("Error creating mandala animation:", e);
      }
    }

    // Enhanced TTS with language detection
    function enhancedTTS(text, autoPlay = false, lang = 'en-US') {
      try {
        console.log("Attempting TTS with language:", lang, "Text:", text.substring(0, 50) + "...");
        if (!window.speechSynthesis) {
          showTTSStatus('TTS not supported', 'error');
          console.error("SpeechSynthesis not supported in this browser.");
          return null;
        }

        window.speechSynthesis.cancel();

        const utterance = new SpeechSynthesisUtterance(text);
        utterance.lang = lang;
        utterance.rate = lang === 'th-TH' ? 0.6 : 0.75;
        utterance.pitch = 0.9;
        utterance.volume = 1.0;

        const voices = window.speechSynthesis.getVoices();
        console.log("Available voices:", voices);
        const preferredVoice = voices.find(voice => 
          voice.lang === lang && 
          (voice.name.includes('Google') || voice.name.includes('Microsoft') || voice.name.includes('Natural'))
        ) || voices.find(voice => voice.lang === lang) || voices[0];

        if (preferredVoice) {
          utterance.voice = preferredVoice;
          console.log("Selected voice:", preferredVoice.name, preferredVoice.lang);
        } else {
          console.warn("No preferred voice found for language:", lang);
        }

        utterance.onstart = () => {
          showTTSStatus(`üîä Speaking in ${lang === 'th-TH' ? 'Pali (Thai)' : 'English'}...`, 'speaking');
          console.log("TTS started speaking");
        };

        utterance.onend = () => {
          hideTTSStatus();
          currentUtterance = null;
          console.log("TTS finished speaking");
        };

        utterance.onerror = (event) => {
          console.error("TTS error:", event.error);
          showTTSStatus(`Voice error: ${event.error}`, 'error');
          currentUtterance = null;
        };

        currentUtterance = utterance;

        if (autoPlay) {
          setTimeout(() => {
            try {
              window.speechSynthesis.speak(utterance);
              console.log("TTS playback initiated");
            } catch (error) {
              console.error("Failed to start TTS:", error);
              showTTSStatus('Failed to start voice', 'error');
            }
          }, 100);
        }

        return utterance;
      } catch (e) {
        console.error("Error in enhancedTTS:", e);
        showTTSStatus('TTS initialization failed', 'error');
        return null;
      }
    }

    // Display a quote in the card - updated to show only englishReading
    function displayQuote(quote) {
      try {
        console.log("Displaying quote:", quote.id, quote.category);
        const quoteCard = document.getElementById('quoteCard');
        const quoteText = document.getElementById('quoteText');
        const englishReading = document.getElementById('englishReading');
        const quoteSource = document.getElementById('quoteSource');

        quoteText.innerHTML = `<span class="pali-text">${quote.text}</span>`;
        englishReading.textContent = quote.englishReading || "";
        quoteSource.textContent = `‚Äî ${quote.source} (${quote.category || ""})`;

        // Apply temple-specific theme using the theme field in passage
        const themeName = quote.theme || "theme-wat-pra-kew";
        console.log("Applying theme:", themeName);
        document.body.className = themeName;

        // Show quote card
        quoteCard.style.display = 'block';
        setTimeout(() => {
          quoteCard.classList.add('show');
          console.log("Quote card shown");
        }, 100);

        updateFavoriteButton();
        updateStats();
      } catch (e) {
        console.error("Error displaying quote:", e);
        showNotification("Failed to display quote.");
      }
    }

    // Toggle favorites
    function toggleFavorite() {
      if (!currentQuote) {
        showNotification("No quote selected to save.");
        return;
      }
      try {
        console.log("Toggling favorite for quote:", currentQuote.id);
        const existingIndex = favorites.findIndex(fav => fav.id === currentQuote.id);
        const isFavorited = existingIndex !== -1;

        if (isFavorited) {
          favorites.splice(existingIndex, 1);
          showNotification('Removed from favorites');
        } else {
          favorites.push(currentQuote);
          showNotification('Added to favorites! ‚ù§Ô∏è');
        }

        localStorage.setItem('favorites', JSON.stringify(favorites));
        updateFavoriteButton();
        updateStats();
        console.log("Favorites updated:", favorites);
      } catch (e) {
        console.error("Error toggling favorite:", e);
        showNotification("Failed to update favorites.");
      }
    }

    // Update favorite button state
    function updateFavoriteButton() {
      try {
        const favoriteBtn = document.getElementById('favoriteBtn');
        if (currentQuote) {
          const isFavorited = favorites.some(fav => fav.id === currentQuote.id);
          favoriteBtn.textContent = isFavorited ? 'üíñ Saved' : '‚ù§Ô∏è Save';
          favoriteBtn.classList.toggle('favorited', isFavorited);
          console.log("Favorite button updated:", isFavorited ? "Saved" : "Save");
        }
      } catch (e) {
        console.error("Error updating favorite button:", e);
      }
    }

    // Send Blessing
    function sendBlessing() {
      if (!currentQuote) {
        showNotification("Please select a passage to send a blessing.");
        return;
      }
      try {
        console.log("Sending blessing for:", currentQuote.category);
        createMandalaAnimation(document.body.className);
        showNotification(`üôèüèª Your blessing has been sent!`);
      } catch (e) {
        console.error("Error sending blessing:", e);
        showNotification("Failed to send blessing.");
      }
    }

    // Play TTS
    function playTTS() {
      if (!currentQuote) {
        showNotification("Please select a passage first.");
        return;
      }
      try {
        console.log("Playing TTS for quote:", currentQuote.id);
        const ttsLanguage = document.getElementById('ttsLanguage').value;
        const textToSpeak = ttsLanguage === 'th-TH' ? currentQuote.text : currentQuote.englishReading;
        enhancedTTS(textToSpeak, true, ttsLanguage);
      } catch (e) {
        console.error("Error playing TTS:", e);
        showNotification("Failed to play TTS.");
      }
    }

    // Play wwbapps TTS with mandala
    function playWWBAppsTTS() {
      if (!currentQuote) {
        showNotification("Please select a passage first.");
        return;
      }
      try {
        console.log("Playing wwbapps TTS for quote:", currentQuote.id);
        const ttsLanguage = document.getElementById('ttsLanguage').value;
        const textToSpeak = ttsLanguage === 'th-TH' ? currentQuote.text : currentQuote.englishReading;
        createMandalaAnimation(document.body.className);
        enhancedTTS(textToSpeak, true, ttsLanguage);
      } catch (e) {
        console.error("Error playing wwbapps TTS:", e);
        showNotification("Failed to play wwbapps TTS.");
      }
    }

    // Generate a new passage
    function generatePassage() {
      if (isGenerating) {
        console.log("Generation already in progress, skipping...");
        return;
      }
      isGenerating = true;
      console.log("Generating new passage...");

      try {
        const sourceFilter = document.getElementById('sourceFilter').value;
        let availablePassages = sourceFilter === 'all' 
          ? passages 
          : passages.filter(p => p.source.includes(sourceFilter));

        availablePassages = availablePassages.filter(p => !usedPassages.includes(p.id));

        if (availablePassages.length === 0) {
          usedPassages = [];
          availablePassages = sourceFilter === 'all' ? passages : passages.filter(p => p.source.includes(sourceFilter));
          localStorage.setItem('usedPassages', JSON.stringify(usedPassages));
          console.log("Reset usedPassages as all were used.");
        }

        const randomPassage = availablePassages[Math.floor(Math.random() * availablePassages.length)];
        usedPassages.push(randomPassage.id);
        localStorage.setItem('usedPassages', JSON.stringify(usedPassages));

        quotesRead++;
        localStorage.setItem('quotesRead', quotesRead.toString());

        currentQuote = randomPassage;
        displayQuote(randomPassage);
        createMandalaAnimation(document.body.className);

        // Auto-play TTS
        const ttsLanguage = document.getElementById('ttsLanguage').value;
        const textToSpeak = ttsLanguage === 'th-TH' ? randomPassage.text : randomPassage.englishReading;
        enhancedTTS(textToSpeak, true, ttsLanguage);

        console.log("Generated passage:", randomPassage.id, randomPassage.category);
        isGenerating = false;
      } catch (e) {
        console.error("Error generating passage:", e);
        showNotification("Failed to generate passage.");
        isGenerating = false;
      }
    }

    // Share quote
    function shareQuote() {
      if (!currentQuote) {
        showNotification("No quote selected to share.");
        return;
      }
      try {
        console.log("Sharing quote:", currentQuote.id);
        const text = `"${currentQuote.text}"\nPronunciation: ${currentQuote.englishReading}\n‚Äî ${currentQuote.source} (${currentQuote.category || ""})`;
        if (navigator.share) {
          navigator.share({
            title: "Sacred Wisdom from Blessing of Siam",
            text: text,
            url: window.location.href
          }).catch(err => {
            console.error("Share failed:", err);
            showNotification("Failed to share. Try copying the quote instead.");
          });
        } else {
          showNotification("Sharing not supported. Copy the quote to share.");
          console.warn("Navigator.share not supported in this browser.");
        }
      } catch (e) {
        console.error("Error sharing quote:", e);
        showNotification("Failed to share quote.");
      }
    }

    // Copy quote
    function copyQuote() {
      if (!currentQuote) {
        showNotification("No quote selected to copy.");
        return;
      }
      try {
        console.log("Copying quote:", currentQuote.id);
        const text = `"${currentQuote.text}"\nPronunciation: ${currentQuote.englishReading}\n‚Äî ${currentQuote.source} (${currentQuote.category || ""})`;
        navigator.clipboard.writeText(text).then(() => {
          showNotification("Quote copied to clipboard! üìã");
        }).catch(err => {
          console.error("Copy failed:", err);
          showNotification("Failed to copy quote.");
        });
      } catch (e) {
        console.error("Error copying quote:", e);
        showNotification("Failed to copy quote.");
      }
    }

    // Show notification
    function showNotification(message) {
      try {
        console.log("Showing notification:", message);
        const notification = document.getElementById('notification');
        notification.textContent = message;
        notification.style.display = 'block';

        setTimeout(() => {
          notification.style.display = 'none';
        }, 3000);
      } catch (e) {
        console.error("Error showing notification:", e);
      }
    }

    // Show TTS status
    function showTTSStatus(message, type = 'speaking') {
      try {
        console.log("Showing TTS status:", message);
        const statusEl = document.getElementById('ttsStatus');
        statusEl.textContent = message;
        statusEl.className = `tts-status ${type}`;
        statusEl.style.display = 'block';

        if (type === 'error') {
          setTimeout(() => {
            statusEl.style.display = 'none';
          }, 3000);
        }
      } catch (e) {
        console.error("Error showing TTS status:", e);
      }
    }

    function hideTTSStatus() {
      try {
        const statusEl = document.getElementById('ttsStatus');
        statusEl.style.display = 'none';
        console.log("Hiding TTS status");
      } catch (e) {
        console.error("Error hiding TTS status:", e);
      }
    }

    // Set theme
    function setTheme(theme) {
      try {
        console.log("Setting theme to:", theme);
        document.body.className = theme;
        localStorage.setItem('selectedTheme', theme);
      } catch (e) {
        console.error("Error setting theme:", e);
        showNotification("Failed to set theme.");
      }
    }

    // Update stats
    function updateStats() {
      try {
        document.getElementById('totalQuotes').textContent = passages.length;
        document.getElementById('quotesRead').textContent = quotesRead;
        document.getElementById('favoriteCount').textContent = favorites.length;
        console.log("Stats updated:", { total: passages.length, read: quotesRead, favorites: favorites.length });
      } catch (e) {
        console.error("Error updating stats:", e);
      }
    }

    // Initialize app
    function initializeApp() {
      try {
        console.log("Initializing Blessing of Siam app...");
        const savedTheme = localStorage.getItem('selectedTheme') || 'theme-wat-pra-kew';
        document.getElementById('themeSelector').value = savedTheme;
        setTheme(savedTheme);

        // Set event listeners with error handling
        document.getElementById('starButton').addEventListener('click', () => {
          console.log("Star button clicked");
          generatePassage();
        });
        document.getElementById('playBtn').addEventListener('click', playTTS);
        document.getElementById('wwbappsBtn').addEventListener('click', playWWBAppsTTS);
        document.getElementById('blessingBtn').addEventListener('click', sendBlessing);
        document.getElementById('favoriteBtn').addEventListener('click', toggleFavorite);
        document.getElementById('shareBtn').addEventListener('click', shareQuote);
        document.getElementById('copyBtn').addEventListener('click', copyQuote);
        document.getElementById('themeSelector').addEventListener('change', (e) => {
          setTheme(e.target.value);
        });

        // Initial notification
        setTimeout(() => {
          showNotification('üôèüèª Welcome to Blessing of Siam! Click Generate Passage to start üôèüèª');
          console.log("Initial notification shown");
        }, 1500);

        console.log("App initialized successfully");
      } catch (e) {
        console.error("Error initializing app:", e);
        showNotification("Failed to initialize app. Please refresh the page.");
      }
    }

    // Load app on DOM ready with fallback
    try {
      if (document.readyState === 'complete' || document.readyState === 'interactive') {
        console.log("DOM already loaded, initializing...");
        initializeApp();
      } else {
        document.addEventListener('DOMContentLoaded', () => {
          console.log("DOM loaded, initializing...");
          initializeApp();
        });
      }
    } catch (e) {
      console.error("Critical error during app load:", e);
      alert("Failed to load Blessing of Siam. Please check console for errors (F12).");
    }
  </script>
</body>
</html>
